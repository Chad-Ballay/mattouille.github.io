<!DOCTYPE html>
<html lang="en">





<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="description" content="In this write up I explore some of the intricacies of Amazon S3's permission matrix. I go over best practices, ACL's, Policies, KMS, and Server Side Encrypti...">
  <meta name="keywords" content="Python, Linux, DevOps, SRE, Site Reliability Engineering, and Automation">
  <meta name="author" content="S3 Bucket Security and Best Practices | MattOuille.com">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#f5f5f5">

  <!-- Twitter Tags -->
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="S3 Bucket Security and Best Practices | MattOuille.com">
  <meta name="twitter:description" content="In this write up I explore some of the intricacies of Amazon S3's permission matrix. I go over best practices, ACL's, Policies, KMS, and Server Side Encrypti...">
  <meta name="twitter:image" content="http://localhost:4000/img/leonids-logo.png">

  <!-- Open Graph Tags -->
  <meta property="og:type" content="blog">
  <meta property="og:url" content="http://localhost:4000">
  <meta property="og:title" content="S3 Bucket Security and Best Practices | MattOuille.com">
  <meta property="og:description" content="In this write up I explore some of the intricacies of Amazon S3's permission matrix. I go over best practices, ACL's, Policies, KMS, and Server Side Encrypti...">
  <meta property="og:image" content="http://localhost:4000/img/leonids-logo.png">
  <title>S3 Bucket Security and Best Practices | MattOuille.com</title>

  <!-- CSS files -->
  <link rel="stylesheet" href="http://localhost:4000/css/font-awesome.min.css">
  <link rel="stylesheet" href="http://localhost:4000/css/main.css">

  <link rel="canonical" href="http://localhost:4000/articles/2017-10/s3-bucket-security-and-best-practices">
  <link rel="alternate" type="application/rss+xml" title="MattOuille.com" href="http://localhost:4000 /feed.xml " />

  <!-- Icons -->
  <!-- 16x16 -->
  <link rel="shortcut icon" href="http://localhost:4000/favicon.ico">
  <!-- 32x32 -->
  <link rel="shortcut icon" href="http://localhost:4000/favicon.png">
</head>


<body>
  <div class="row">
    <div class="col s12 m3">
      <div class="table cover">
        

<div class="cover-card table-cell table-middle">
  
  <img src="http://localhost:4000/img/profile.jpg" alt="" class="avatar">
  
  <a href="http://localhost:4000/" class="author_name">Matt Ouille</a>
  <span class="author_job">Site Reliability Engineer</span>
  <span class="author_bio mbm">A software engineer focused on infrastructure automation, Linux, and service reliability.</span>
  <nav class="nav">
    <ul class="nav-list">
      <li class="nav-item">
        <a href="http://localhost:4000/">home</a>
        <span>/</span>
      </li>
       
      <li class="nav-item">
        <a href="http://localhost:4000/about-me/">About Me</a>
        
          <span>/</span>
        
      </li>
        
      <li class="nav-item">
        <a href="http://localhost:4000/archive/">Archive</a>
        
          <span>/</span>
        
      </li>
          
      <li class="nav-item">
        <a href="http://localhost:4000/categories/">Categories</a>
        
          <span>/</span>
        
      </li>
        
      <li class="nav-item">
        <a href="http://localhost:4000/categories/">Categories</a>
        
          <span>/</span>
        
      </li>
          
      <li class="nav-item">
        <a href="http://localhost:4000/tags/">Tags</a>
        
          <span>/</span>
        
      </li>
          
      <li class="nav-item">
        <a href="http://localhost:4000/">Update 05/06/2016</a>
        
      </li>
       
    </ul>
  </nav>
  <script type="text/javascript">
  // based on http://stackoverflow.com/a/10300743/280842
  function gen_mail_to_link(hs, subject) {
    var lhs,rhs;
    var p = hs.split('@');
    lhs = p[0];
    rhs = p[1];
    document.write("<a class=\"social-link-item\" target=\"_blank\" href=\"mailto");
    document.write(":" + lhs + "@");
    document.write(rhs + "?subject=" + subject + "\"><i class=\"fa fa-fw fa-envelope\"></i><\/a>");
  }
</script>
<div class="social-links">
  <ul>
    
      <li>
      <script>gen_mail_to_link('matthew.ouille@gmail.com', 'Hello from website');</script>
      </li>
    
    
    
    
    <li><a href="http://linkedin.com/in/mattouille" class="social-link-item" target="_blank"><i class="fa fa-fw fa-linkedin"></i></a></li>
    
    
    
    <li><a href="http://github.com/mattouille" class="social-link-item" target="_blank"><i class="fa fa-fw fa-github"></i></a></li>
    <li><a href="http://stackoverflow.com/users/5854293/matt-o" class="social-link-item" target="_blank"><i class="fa fa-fw fa-stack-overflow"></i></a></li>
    
    
    
    
    
    
    
    
    
    
    
  </ul>
</div>

</div>

      </div>
    </div>
    <div class="col s12 m9">
      <div class="post-listing">
        <a class="btn" href= "http://localhost:4000/" >
  Home
</a>



<div id="post">
  <header class="post-header">
    <h1 title="S3 Bucket Security and Best Practices">S3 Bucket Security and Best Practices</h1>
    <span class="post-meta">
      <span class="post-date">
        16 OCT 2017
      </span>
      •
      <span class="read-time" title="Estimated read time">
  
  
    6 mins read
  
</span>

    </span>

  </header>

  <article class="post-content">
    <p>There’s been a litany of companies with unsecured S3 buckets including <a href="https://www.theregister.co.uk/2017/09/22/verizon_falls_for_the_old_unguarded_aws_s3_bucket_trick_exposes_internal_system/">Verizon</a>, <a href="https://www.theregister.co.uk/2017/10/10/accenture_amazon_aws_s3/">Accenture</a>, <a href="https://threatpost.com/four-million-time-warner-cable-records-left-on-misconfigured-aws-s3/127807/">TimeWarner</a>, and the list goes on.</p>

<h2 id="so-what-is-a-vulnerable-s3-bucket">So what is a vulnerable S3 bucket?</h2>

<h3 id="acls-and-policies">ACLs and policies</h3>

<p>S3 has some quirks. First and foremost that I’ve identified is it’s <em>permissions system</em> known as <em><a href="http://docs.aws.amazon.com/AmazonS3/latest/dev/acl-overview.html">ACL’s</a></em> and <em><a href="http://docs.aws.amazon.com/AmazonS3/latest/dev/using-iam-policies.html">Policies</a></em>. I’m going to kick this off with <strong>vanilla S3 buckets DENY by default.</strong> There’s a nice little ACL that comes with every bucket that allows access account wide and that’s it. If you create an S3 bucket and do nothing else with it, this bucket is largely secure (unless someone gains access to your account, but that’s out of scope here).</p>

<p>ACL’s are just as they sound, they’re <em>access control lists</em> where you can grant permissions or denies to accounts, users, groups, etc…</p>

<p>Policies are very fine grained, expressive, and written in JSON. They’re very comparable to ACL’s, except they require referencing <em>existing</em> resources with ARN’s (Amazon Resource Names).</p>

<p><strong>So what’s the difference?</strong> <a href="https://aws.amazon.com/blogs/security/iam-policies-and-bucket-policies-and-acls-oh-my-controlling-access-to-s3-resources/">Amazon regards S3 ACL’s as legacy</a>, so I don’t use them aside for the given ACL (<em>ALLOW</em> to resources in your account). In fact, in most cases I’ll remove that ACL and define a policy to reflect it if it’s needed. The reason I do this is maintaining a <em>single source of truth</em>. <strong>In many cases if you mix ACL’s and policies determining the outcome can become very tricky and cumbersome.</strong> Policies reflect on all the objects in an S3 bucket, Amazon phrases this as they’re <em>postured at the bucket level</em>. <strong>This means if you find yourself in a predicament where some objects need a policy and others don’t they should likely be in different buckets.</strong></p>

<p>Yes, I know you can apply policies to folders, but really in the age of IaaS I’m sure you’ve discovered this can be cumbersome as well. Let’s examine that scenario below:</p>

<p>Let’s say I’m using Terraform (or CloudFormation) to provision an S3 bucket. The whole goal with IaaS is to provision and require <em>zero</em> manual steps. I define my S3 Bucket, next I need to create a policy and specify the bucket it attaches to. <em>Keep in mind I can only reference things in my policy that already exist</em>. I would actually have to create a script that goes and creates a folder and then executes the policy creation and attachment. In this case it’s not only easier but safer to provision different buckets for different policies.</p>

<h2 id="let-the-best-practices-begin">Let the best practices begin.</h2>

<h3 id="reining-in-the-policies">Reining in the policies</h3>

<p>One of the unfortunate things that I see frequently is engineers or developers using <code class="highlighter-rouge">Principal: "*"</code> in policies. <em>Principal</em> is the <em>who</em> in <em><strong>who</strong> can use <strong>what</strong></em> while <em>Resource</em> refers to <em>what</em>. The <code class="highlighter-rouge">"*"</code> actually indicates that <em>any resource</em> can use the bucket you’ve assigned this to, including resources or users outside your account. I can literally log onto another computer with AWS CLI installed and read or post files to your S3 bucket if your policies aren’t specified correctly.</p>

<blockquote>
  <p>You can try this by using a computer with no (or different) AWS credentials and the CLI installed. Simply create a file, apply a junk principal policy and copy it in with <code class="highlighter-rouge">aws s3 cp file.txt s3://yourbucket/</code>. Voila! Go ahead, make it interesting and throw some ACL denies in there too. Watch as your efforts are futile.</p>
</blockquote>

<p><code class="highlighter-rouge">Principal: "*"</code> is useful if you have a website hosted off of Amazon S3. I might use a policy like this:</p>

<div class="language-json highlighter-rouge"><pre class="highlight"><code><span class="w"> </span><span class="p">{</span><span class="w">
   </span><span class="nt">"Version"</span><span class="p">:</span><span class="s2">"2012-10-17"</span><span class="p">,</span><span class="w">
   </span><span class="nt">"Id"</span><span class="p">:</span><span class="s2">"http referer policy example"</span><span class="p">,</span><span class="w">
   </span><span class="nt">"Statement"</span><span class="p">:[</span><span class="w">
     </span><span class="p">{</span><span class="w">
       </span><span class="nt">"Sid"</span><span class="p">:</span><span class="s2">"Allow get requests originating from www.example.com and example.com."</span><span class="p">,</span><span class="w">
       </span><span class="nt">"Effect"</span><span class="p">:</span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
       </span><span class="nt">"Principal"</span><span class="p">:</span><span class="s2">"*"</span><span class="p">,</span><span class="w">
       </span><span class="nt">"Action"</span><span class="p">:</span><span class="s2">"s3:GetObject"</span><span class="p">,</span><span class="w">
       </span><span class="nt">"Resource"</span><span class="p">:</span><span class="s2">"arn:aws:s3:::examplebucket/*"</span><span class="p">,</span><span class="w">
       </span><span class="nt">"Condition"</span><span class="p">:{</span><span class="w">
         </span><span class="nt">"StringLike"</span><span class="p">:{</span><span class="nt">"aws:Referer"</span><span class="p">:[</span><span class="s2">"http://www.example.com/*"</span><span class="p">,</span><span class="s2">"http://example.com/*"</span><span class="p">]}</span><span class="w">
       </span><span class="p">}</span><span class="w">
     </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nt">"Sid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Explicit deny to ensure requests are allowed only from specific referer."</span><span class="p">,</span><span class="w">
        </span><span class="nt">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Deny"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"Principal"</span><span class="p">:</span><span class="w"> </span><span class="s2">"*"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"Action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"s3:*"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="s2">"arn:aws:s3:::examplebucket/*"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"Condition"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nt">"StringNotLike"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">"aws:Referer"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"http://www.example.com/*"</span><span class="p">,</span><span class="s2">"http://example.com/*"</span><span class="p">]}</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
   </span><span class="p">]</span><span class="w">
 </span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<p>In this example not only have I attributed an explicit <em>ALLOW</em> but I’ve also attributed an explicit <em>DENY</em>.</p>

<h3 id="reciprocity-is-worth-mentioning">Reciprocity is worth mentioning</h3>

<p>A lot of folks that I find making unsafe S3 policies are doing so because they can’t figure out the mess between ACL’s and Policies (which I’ve now explained) as well as reciprocity between <em>IAM Policies</em> and <em>Bucket Policies</em>. Anything that you reflect in your <em>Bucket Policy</em> should reflect in your <em>IAM Policy</em>. IAM Policies are used conjoiningly with STS:AssumeRole and Trusts. If I grant <em>s3:GetObject</em> in my Bucket Policy, I need to grant <em>s3:GetObject</em> in my IAM Policy TO that resource. <strong>AGAIN</strong>, make it to the specific resource rather than <code class="highlighter-rouge">"*"</code> unless you have a very good reason.</p>

<h3 id="lock-everything-down-to-roles">Lock everything down to roles</h3>

<p>I always make a habit of <strong>referencing roles with Principals</strong>. A principal can be assigned to a variety of things such as an <em>account</em>, <em>user</em>, <em>role</em>, and <em>service</em>. That said, just because you <em>can</em> doesn’t mean you <em>should</em>. Rather than giving all your EC2 instances access with <code class="highlighter-rouge">Service: ec2.amazonaws.com</code> specify the rule and assign an STS Trust to that IAM Profile. You could equate this to the “Principal of least privilege”, much like buckets and bucket permissions could be described as “Doing one thing and doing it well”.</p>

<h3 id="kms-and-sse">KMS and SSE</h3>

<p>AWS provides the <em>Key Management Service</em> (For everything) and <em>Server Side Encryption</em> (For S3 Buckets). When you upload and download files/objects you can specify an AWS KMS Key to use. Furthermore you can restrict keys using policies! The same approach you used with bucket policies can be used with KMS Key policies, restricting them to certain roles is <em>always</em> a hardy best practice. This keeps everything segregated but also continuing to flow nicely without stoppages. Additionally, should an instance or resource with a particular role ever be compromised you can simply roll that <em>one</em> KMS key. You can refer to AWS KMS Key’s using Bucket Policy conditionals.</p>

<div class="language-json highlighter-rouge"><pre class="highlight"><code><span class="p">{</span><span class="w">
   </span><span class="nt">"Version"</span><span class="p">:</span><span class="s2">"2012-10-17"</span><span class="p">,</span><span class="w">
   </span><span class="nt">"Id"</span><span class="p">:</span><span class="s2">"PutObjPolicy"</span><span class="p">,</span><span class="w">
   </span><span class="nt">"Statement"</span><span class="p">:[{</span><span class="w">
         </span><span class="nt">"Sid"</span><span class="p">:</span><span class="s2">"DenyUnEncryptedObjectUploads"</span><span class="p">,</span><span class="w">
         </span><span class="nt">"Effect"</span><span class="p">:</span><span class="s2">"Deny"</span><span class="p">,</span><span class="w">
         </span><span class="nt">"Principal"</span><span class="p">:</span><span class="s2">"*"</span><span class="p">,</span><span class="w">
         </span><span class="nt">"Action"</span><span class="p">:</span><span class="s2">"s3:PutObject"</span><span class="p">,</span><span class="w">
         </span><span class="nt">"Resource"</span><span class="p">:</span><span class="s2">"arn:aws:s3:::YourBucket/*"</span><span class="p">,</span><span class="w">
         </span><span class="nt">"Condition"</span><span class="p">:{</span><span class="w">
            </span><span class="nt">"StringNotEquals"</span><span class="p">:{</span><span class="w">
               </span><span class="nt">"s3:x-amz-server-side-encryption"</span><span class="p">:</span><span class="s2">"aws:kms"</span><span class="w">
            </span><span class="p">}</span><span class="w">
         </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
   </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<p>The above policy allows you to use <em>any</em> or the <em>default</em> KMS key, however, you can further specify keys in your conditional: <code class="highlighter-rouge">"s3:x-amz-server-side-encryption-aws-kms-key-id": "arn:aws:kms:region:acct-id:key/key-id"</code>.</p>

<p>I won’t delve too much into <a href="http://docs.aws.amazon.com/kms/latest/developerguide/key-policies.html">KMS Key Policies but they can be explained here</a> and, again, are much like the bucket policies I explained above.</p>

<h2 id="related-links">Related Links</h2>
<ul>
  <li><a href="https://blog.rapid7.com/2013/03/27/open-s3-buckets/">Hacking S3 Buckets</a></li>
</ul>

  </article>
</div>

<div class="share-buttons">
  <h6>Share on: </h6>
  <ul>
    <li>
      <a href="https://twitter.com/intent/tweet?text=http://localhost:4000/articles/2017-10/s3-bucket-security-and-best-practices" class="twitter btn" title="Share on Twitter"><i class="fa fa-twitter"></i><span> Twitter</span></a>
    </li>
    <li>
      <a href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/articles/2017-10/s3-bucket-security-and-best-practices" class="facebook btn" title="Share on Facebook"><i class="fa fa-facebook"></i><span> Facebook</span></a>
    </li>
    <li>
      <a href="https://plus.google.com/share?url=http://localhost:4000/articles/2017-10/s3-bucket-security-and-best-practices" class="google-plus btn" title="Share on Google Plus"><i class="fa fa-google-plus"></i><span> Google+</span></a>
    </li>
    <li>
      <a href="https://news.ycombinator.com/submitlink?u=http://localhost:4000/articles/2017-10/s3-bucket-security-and-best-practices" class="hacker-news btn" title="Share on Hacker News"><i class="fa fa-hacker-news"></i><span> Hacker News</span></a>
    </li>
    <li>
      <a href="https://www.reddit.com/submit?url=http://localhost:4000/articles/2017-10/s3-bucket-security-and-best-practices" class="reddit btn" title="Share on Reddit"><i class="fa fa-reddit"></i><span> Reddit</span></a>
    </li>
  </ul>
</div><!-- end share-buttons -->



        <footer>
  &copy; 2017 Matt Ouille. Powered by <a href="http://jekyllrb.com/">Jekyll</a>, <a href="http://github.com/renyuanz/leonids/">leonids theme</a> made with <i class="fa fa-heart heart-icon"></i>
</footer>

      </div>
    </div>
  </div>
  <script type="text/javascript" src="http://localhost:4000/js/jquery-3.2.1.min.js"></script>
<script type="text/javascript" src="http://localhost:4000/js/main.js"></script>

<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-49694865-1', 'auto');
  ga('send', 'pageview');
</script>



</body>
</html>
