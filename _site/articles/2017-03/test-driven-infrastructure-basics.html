<!DOCTYPE html>
<html lang="en">





<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="description" content="Today I’m going to go over the basics of Test Driven Infrastructure, what it means, how to do it, when it applies, and why. In this tutorial I’m going to use...">
  <meta name="keywords" content="Python, Linux, DevOps, SRE, Site Reliability Engineering, and Automation">
  <meta name="author" content="Test Driven Infrastructure Basics | MattOuille.com">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#f5f5f5">

  <!-- Twitter Tags -->
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Test Driven Infrastructure Basics | MattOuille.com">
  <meta name="twitter:description" content="Today I’m going to go over the basics of Test Driven Infrastructure, what it means, how to do it, when it applies, and why. In this tutorial I’m going to use...">
  <meta name="twitter:image" content="https://www.mattouille.com/img/leonids-logo.png">

  <!-- Open Graph Tags -->
  <meta property="og:type" content="blog">
  <meta property="og:url" content="https://www.mattouille.com">
  <meta property="og:title" content="Test Driven Infrastructure Basics | MattOuille.com">
  <meta property="og:description" content="Today I’m going to go over the basics of Test Driven Infrastructure, what it means, how to do it, when it applies, and why. In this tutorial I’m going to use...">
  <meta property="og:image" content="https://www.mattouille.com/img/leonids-logo.png">
  <title>Test Driven Infrastructure Basics | MattOuille.com</title>

  <!-- CSS files -->
  <link rel="stylesheet" href="https://www.mattouille.com/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://www.mattouille.com/css/main.css">

  <link rel="canonical" href="https://www.mattouille.com/articles/2017-03/test-driven-infrastructure-basics">
  <link rel="alternate" type="application/rss+xml" title="MattOuille.com" href="https://www.mattouille.com /feed.xml " />

  <!-- Icons -->
  <!-- 16x16 -->
  <link rel="shortcut icon" href="https://www.mattouille.com/favicon.ico">
  <!-- 32x32 -->
  <link rel="shortcut icon" href="https://www.mattouille.com/favicon.png">
</head>


<body>
  <div class="row">
    <div class="col s12 m3">
      <div class="table cover">
        

<div class="cover-card table-cell table-middle">
  
  <img src="https://www.mattouille.com/img/profile.jpg" alt="" class="avatar">
  
  <a href="https://www.mattouille.com/" class="author_name">Matt Ouille</a>
  <span class="author_job">Site Reliability Engineer</span>
  <span class="author_bio mbm">A software engineer focused on infrastructure automation, Linux, and service reliability.</span>
  <nav class="nav">
    <ul class="nav-list">
      <li class="nav-item">
        <a href="https://www.mattouille.com/">home</a>
        <span>/</span>
      </li>
       
      <li class="nav-item">
        <a href="https://www.mattouille.com/about-me/">About Me</a>
        
          <span>/</span>
        
      </li>
        
      <li class="nav-item">
        <a href="https://www.mattouille.com/archive/">Archive</a>
        
          <span>/</span>
        
      </li>
          
      <li class="nav-item">
        <a href="https://www.mattouille.com/categories/">Categories</a>
        
          <span>/</span>
        
      </li>
        
      <li class="nav-item">
        <a href="https://www.mattouille.com/categories/">Categories</a>
        
          <span>/</span>
        
      </li>
          
      <li class="nav-item">
        <a href="https://www.mattouille.com/tags/">Tags</a>
        
      </li>
       
    </ul>
  </nav>
  <script type="text/javascript">
  // based on http://stackoverflow.com/a/10300743/280842
  function gen_mail_to_link(hs, subject) {
    var lhs,rhs;
    var p = hs.split('@');
    lhs = p[0];
    rhs = p[1];
    document.write("<a class=\"social-link-item\" target=\"_blank\" href=\"mailto");
    document.write(":" + lhs + "@");
    document.write(rhs + "?subject=" + subject + "\"><i class=\"fa fa-fw fa-envelope\"></i><\/a>");
  }
</script>
<div class="social-links">
  <ul>
    
      <li>
      <script>gen_mail_to_link('matthew.ouille@gmail.com', 'Hello from website');</script>
      </li>
    
    
    
    
    <li><a href="http://linkedin.com/in/mattouille" class="social-link-item" target="_blank"><i class="fa fa-fw fa-linkedin"></i></a></li>
    
    
    
    <li><a href="http://github.com/mattouille" class="social-link-item" target="_blank"><i class="fa fa-fw fa-github"></i></a></li>
    <li><a href="http://stackoverflow.com/users/5854293/matt-o" class="social-link-item" target="_blank"><i class="fa fa-fw fa-stack-overflow"></i></a></li>
    
    
    
    
    
    
    
    
    
    
    
  </ul>
</div>

</div>

      </div>
    </div>
    <div class="col s12 m9">
      <div class="post-listing">
        <a class="btn" href= "https://www.mattouille.com/" >
  Home
</a>



<div id="post">
  <header class="post-header">
    <h1 title="Test Driven Infrastructure Basics">Test Driven Infrastructure Basics</h1>
    <span class="post-meta">
      <span class="post-date">
        23 MAR 2017
      </span>
      •
      <span class="read-time" title="Estimated read time">
  
  
    8 mins read
  
</span>

    </span>

  </header>

  <article class="post-content">
    <p>Today I’m going to go over the basics of Test Driven Infrastructure, what it means, how to do it, when it applies, and why. In this tutorial I’m going to use Chef, but you can use whatever you want.</p>

<!--more-->

<p><strong>Test Driven Infrastructure</strong> (TDI) is a term that’s been somewhat borrowed from the software engineering concept of <strong>Test Driven Development</strong> (TDD). While TDD is somewhat questioned in certain facets, everybody can agree that automated testing is the best way forward. TDI basically implies that we build the tests before we build out infrastructure. If this sounds a little shocking, let me explain:</p>

<p>Say I want to build a brand new server to host my blog and it’s database. We know we have some initial requirements which can fall under compliance (Securing SSH, establishing firewall rules, etc…). We also know that I’ll need Apache, PHP, and mySQL. Generally, we already know what to test before we build it as we’ve proven.</p>

<ul>
  <li>Apache2 is installed &amp; running as a service</li>
  <li>Apache2 listens on port 80</li>
  <li>mySQL is installed &amp; running as a service</li>
  <li>mysqld is listening on port 3306/tcp via localhost</li>
</ul>

<p>That wasn’t too difficult. How do we turn that into tests? You’re about to find out that it’s almost as easy as speaking English.</p>

<div class="alert alert-info"><i>Why didn't I mentioned I'm using InSpec before? Most test frameworks are mostly the same. This is just about the basics.</i></div>

<p>Depending on what Configuration Management software you use, you’ll have to configure your resource to be tested differently. Here’s my .kitchen.yml file</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="nn">---</span>
<span class="s">driver</span><span class="pi">:</span>
  <span class="s">name</span><span class="pi">:</span> <span class="s">vagrant</span>

<span class="s">provisioner</span><span class="pi">:</span>
  <span class="s">name</span><span class="pi">:</span> <span class="s">chef_zero</span>
  <span class="c1"># You may wish to disable always updating cookbooks in CI or other testing environments.</span>
  <span class="c1"># For example:</span>
  <span class="c1">#   always_update_cookbooks: &lt;%= !ENV['CI'] %&gt;</span>
  <span class="s">always_update_cookbooks</span><span class="pi">:</span> <span class="s">true</span>

<span class="s">verifier</span><span class="pi">:</span>
  <span class="s">name</span><span class="pi">:</span> <span class="s">inspec</span>

<span class="s">platforms</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">name</span><span class="pi">:</span> <span class="s">ubuntu-16.04</span>

<span class="s">suites</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">name</span><span class="pi">:</span> <span class="s">default</span>
    <span class="s">run_list</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">recipe[mattouille::default]</span>
    <span class="s">verifier</span><span class="pi">:</span>
      <span class="s">inspec_tests</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">test/smoke/default</span>
    <span class="s">attributes</span><span class="pi">:</span></code></pre></figure>

<p>Our tests will be located relative to the .kitchen.yml file. Notice we specified <code class="highlighter-rouge">test/smoke/default</code>. It’s labeled <code class="highlighter-rouge">default</code> because it’s in reference to default.rb. This helps us stay organized. Next create <code class="highlighter-rouge">default_test.rb</code> in the <code class="highlighter-rouge">default</code> folder you just created.</p>

<p><em>Note</em> Every test document should be formatted with <code class="highlighter-rouge">*_test.rb</code></p>

<p>InSpec is nice and simple. You can be as simple or as complex as you want. Here’s a <a href="http://inspec.io/docs/">copy of the documentation</a> in case you were wondering where I get all this magical goodness.</p>

<p>Let’s start out by defining our Apache test. Remember what we wrote down earlier:</p>

<ul>
  <li>Apache2 is installed &amp; running as a service</li>
  <li>Apache2 listens on port 80</li>
</ul>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">describe</span> <span class="n">package</span> <span class="s1">'apache2'</span> <span class="k">do</span>
	<span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_installed</span> <span class="p">}</span>
<span class="k">end</span>

<span class="n">describe</span> <span class="n">service</span><span class="p">(</span><span class="n">apache</span><span class="p">.</span><span class="nf">service</span><span class="p">)</span> <span class="k">do</span>
	<span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_enabled</span> <span class="p">}</span>
	<span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_running</span> <span class="p">}</span>
<span class="k">end</span>

<span class="n">describe</span> <span class="n">port</span><span class="p">(</span><span class="mi">80</span><span class="p">)</span> <span class="k">do</span>
	<span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_listening</span> <span class="p">}</span>
	<span class="n">its</span><span class="p">(</span><span class="s1">'processes'</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="kp">include</span> <span class="s1">'apache2'</span> <span class="p">}</span>
<span class="k">end</span></code></pre></figure>

<h4 id="explanation">Explanation</h4>

<p>InSpec (and other test frameworks) run agentless (from the host) after all the configuration magic has happened. First we check to make sure the package is installed. We can assume by this point that Apache <em>should</em> be up and running rather painlessly. It is empty after all, with just the default start page. At the same time we check to make sure that the service is enabled. InSpec knows how to interact with SystemD on it’s own but has built in resources to check for SystemD, UpStart, etc… if you need them. Next, we make sure that the Apache2 process is the one listening on port 80. Now we’re all set!</p>

<p>Lastly we’ll tackle mySQL. Here’s what we wrote down earlier:</p>

<ul>
  <li>mySQL is installed &amp; running as a service</li>
  <li>mysqld is listening on port 3306/tcp via localhost</li>
</ul>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># --- Apache Stuff ---</span>

<span class="n">describe</span> <span class="n">package</span> <span class="s1">'mysql-server'</span> <span class="k">do</span>
	<span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_installed</span> <span class="p">}</span>
<span class="k">end</span>

<span class="n">describe</span> <span class="n">service</span><span class="p">(</span><span class="n">mysql</span><span class="p">.</span><span class="nf">service</span><span class="p">)</span> <span class="k">do</span>
	<span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_enabled</span> <span class="p">}</span>
	<span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_running</span> <span class="p">}</span>
<span class="k">end</span>

<span class="n">describe</span> <span class="n">port</span><span class="p">(</span><span class="mi">3306</span><span class="p">)</span> <span class="k">do</span>
	<span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_listening</span> <span class="p">}</span>
	<span class="n">its</span><span class="p">(</span><span class="s1">'protocols'</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="kp">include</span> <span class="s1">'tcp'</span> <span class="p">}</span>
	<span class="n">its</span><span class="p">(</span><span class="s1">'processes'</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="kp">include</span> <span class="s1">'mysqld'</span> <span class="p">}</span>
	<span class="n">its</span><span class="p">(</span><span class="s1">'addresses'</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="kp">include</span> <span class="s1">'127.0.0.1'</span><span class="p">}</span>
<span class="k">end</span></code></pre></figure>

<h4 id="explanation-1">Explanation</h4>

<p>MySQL gets a little trickier because you install the mysql-server package, there is a mysql service, however, mysqld is what handles all the interaction with data. First we check to see that the package is installed. Then we check to see that the service is enabled and running. Lastly we make sure that 3306 is open, listening for TCP requests via mysqld on 127.0.0.1.</p>

<div class="alert alert-warning">If you go looking for the wrong process listening on a port, InSpec will actually tell you what process is listening. You should obviously verify that this is correct, but it definitely aids in the education process.</div>

<h4 id="profiles">Profiles</h4>

<p>Each framework has their own grouping mechanisms. InSpec calls theirs profiles. Review the changes I’ve made to our script below:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">control</span> <span class="s1">'Apache Daemon'</span> <span class="k">do</span>
	<span class="n">impact</span> <span class="mi">1</span><span class="o">.</span><span class="mi">0</span>
	<span class="n">title</span> <span class="s1">'Server: Configure daemon and service port'</span>
	<span class="n">desc</span> <span class="s1">'
		Enable the service and specify the port used.
	'</span>

	<span class="n">describe</span> <span class="n">package</span> <span class="s1">'apache2'</span> <span class="k">do</span>
		<span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_installed</span> <span class="p">}</span>
	<span class="k">end</span>

	<span class="n">describe</span> <span class="n">service</span><span class="p">(</span><span class="n">apache</span><span class="p">.</span><span class="nf">service</span><span class="p">)</span> <span class="k">do</span>
		<span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_enabled</span> <span class="p">}</span>
		<span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_running</span> <span class="p">}</span>
	<span class="k">end</span>

	<span class="n">describe</span> <span class="n">port</span><span class="p">(</span><span class="mi">80</span><span class="p">)</span> <span class="k">do</span>
		<span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_listening</span> <span class="p">}</span>
		<span class="n">its</span><span class="p">(</span><span class="s1">'processes'</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="kp">include</span> <span class="s1">'apache2'</span> <span class="p">}</span>
	<span class="k">end</span>
<span class="k">end</span>

<span class="n">control</span> <span class="s1">'MySQL Daemon'</span> <span class="k">do</span>
	<span class="n">impact</span> <span class="mi">1</span><span class="o">.</span><span class="mi">0</span>
	<span class="n">title</span> <span class="s1">'Server: Configure daemon and service port'</span>
	<span class="n">desc</span> <span class="s1">'
		Enable the service and specify the port and address used.
	'</span>

	<span class="n">describe</span> <span class="n">package</span> <span class="s1">'mysql-server'</span> <span class="k">do</span>
		<span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_installed</span> <span class="p">}</span>
	<span class="k">end</span>

	<span class="n">describe</span> <span class="n">service</span><span class="p">(</span><span class="n">mysql</span><span class="p">.</span><span class="nf">service</span><span class="p">)</span> <span class="k">do</span>
		<span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_enabled</span> <span class="p">}</span>
		<span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_running</span> <span class="p">}</span>
	<span class="k">end</span>

	<span class="n">describe</span> <span class="n">port</span><span class="p">(</span><span class="mi">3306</span><span class="p">)</span> <span class="k">do</span>
		<span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_listening</span> <span class="p">}</span>
		<span class="n">its</span><span class="p">(</span><span class="s1">'protocols'</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="kp">include</span> <span class="s1">'tcp'</span> <span class="p">}</span>
		<span class="n">its</span><span class="p">(</span><span class="s1">'processes'</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="kp">include</span> <span class="s1">'mysqld'</span> <span class="p">}</span>
		<span class="n">its</span><span class="p">(</span><span class="s1">'addresses'</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="kp">include</span> <span class="s1">'127.0.0.1'</span><span class="p">}</span>
	<span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>I’ve added some additional information to cover the impact, group each test, and provide a brief description. At this point we could go ahead and write our configuration code. Once we’re done we can run our tests and make sure everything lined up. Let’s see what happens when I run <code class="highlighter-rouge">kitchen verify</code> on my code:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="gp">-----&gt; </span>Verifying &lt;default-ubuntu-1604&gt;...
       Loaded  

Target:  ssh://vagrant@127.0.0.1:2222

  ✔  Apache Daemon: Server: Configure daemon and service port
     ✔  System Package apache2 should be installed
     ✔  Service apache2 should be enabled
     ✔  Service apache2 should be running
     ✔  Port 80 should be listening
     ✔  Port 80 processes should include <span class="s2">"apache2"</span>
  ✔  MySQL Daemon: Server: Configure daemon and service port
     ✔  System Package mysql-server should be installed
     ✔  Service mysql should be enabled
     ✔  Service mysql should be running
     ✔  Port 3306 should be listening
     ✔  Port 3306 protocols should include <span class="s2">"tcp"</span>
     ✔  Port 3306 processes should include <span class="s2">"mysqld"</span>
     ✔  Port 3306 addresses should include <span class="s2">"127.0.0.1"</span>

Profile Summary: 2 successful, 0 failures, 0 skipped
Test Summary: 12 successful, 0 failures, 0 skipped
       Finished verifying &lt;default-ubuntu-1604&gt; <span class="o">(</span>0m3.64s<span class="o">)</span>.
<span class="gp">-----&gt; </span>Kitchen is finished. <span class="o">(</span>0m4.66s<span class="o">)</span></code></pre></figure>

<p>You probably can’t see it very well so I’ve highlighted the lines, but there’s checks out to the left of each test and profile. This means they passed! There’s obviously a lot more to discuss about TDI as well as testing that automated deployments occur correctly but that’s for a follow-on article.</p>

<h4 id="where-does-tdi-apply">Where does TDI apply?</h4>

<p>Well, this is kind of up to you. In terms of TDD, some people say you should build the tests first and the applications second. Others say you should be able to take an objective look at your infrastructure and understand the root of what it’s trying to accomplish and test for results. There’s arguments for both, but ultimately you and your organization need to make that decision. Regardless, deploying without testing is foolish.</p>

<h4 id="where-can-tdi-be-used">Where can TDI be used?</h4>

<p>TDI is really part of the CI/CD process. You can make this an integral part of your build process using Jenkins or GoCD, or you can test locally.</p>

<p>Thanks for reading!</p>

  </article>
</div>

<div class="share-buttons">
  <h6>Share on: </h6>
  <ul>
    <li>
      <a href="https://twitter.com/intent/tweet?text=https://www.mattouille.com/articles/2017-03/test-driven-infrastructure-basics" class="twitter btn" title="Share on Twitter"><i class="fa fa-twitter"></i><span> Twitter</span></a>
    </li>
    <li>
      <a href="https://www.facebook.com/sharer/sharer.php?u=https://www.mattouille.com/articles/2017-03/test-driven-infrastructure-basics" class="facebook btn" title="Share on Facebook"><i class="fa fa-facebook"></i><span> Facebook</span></a>
    </li>
    <li>
      <a href="https://plus.google.com/share?url=https://www.mattouille.com/articles/2017-03/test-driven-infrastructure-basics" class="google-plus btn" title="Share on Google Plus"><i class="fa fa-google-plus"></i><span> Google+</span></a>
    </li>
    <li>
      <a href="https://news.ycombinator.com/submitlink?u=https://www.mattouille.com/articles/2017-03/test-driven-infrastructure-basics" class="hacker-news btn" title="Share on Hacker News"><i class="fa fa-hacker-news"></i><span> Hacker News</span></a>
    </li>
    <li>
      <a href="https://www.reddit.com/submit?url=https://www.mattouille.com/articles/2017-03/test-driven-infrastructure-basics" class="reddit btn" title="Share on Reddit"><i class="fa fa-reddit"></i><span> Reddit</span></a>
    </li>
  </ul>
</div><!-- end share-buttons -->



        <footer>
  &copy; 2017 Matt Ouille. Powered by <a href="http://jekyllrb.com/">Jekyll</a>, <a href="http://github.com/renyuanz/leonids/">leonids theme</a> made with <i class="fa fa-heart heart-icon"></i>
</footer>

      </div>
    </div>
  </div>
  <script type="text/javascript" src="https://www.mattouille.com/js/jquery-3.2.1.min.js"></script>
<script type="text/javascript" src="https://www.mattouille.com/js/main.js"></script>

<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-49694865-1', 'auto');
  ga('send', 'pageview');
</script>



</body>
</html>
